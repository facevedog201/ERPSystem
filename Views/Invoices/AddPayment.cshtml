@model ERPSystem.Models.Invoice
@{
    ViewData["Title"] = "Agregar Pago";
    bool isReadOnly = Model.Status == (int?)ERPSystem.Models.InvoiceStatus.Cancelled || Model.Status == (int?)ERPSystem.Models.InvoiceStatus.Paid;
}

<h2>Agregar Pago a Factura #@Model.InvoiceId</h2>

<div class="card mt-3">
    <div class="card-body">
        <h5 class="card-title">Resumen de Factura</h5>
        <p><strong>Cliente:</strong> @Model.Client?.Name</p>
        <p><strong>Fecha:</strong> @(Model.InvoiceDate?.ToString("dd/MM/yyyy", System.Globalization.CultureInfo.InvariantCulture) ?? "01/01/0000")</p>
        <p><strong>Total:</strong> @(Model.Total?.ToString("C") ?? "0.0")</p>
        <p><strong>Pagado:</strong> @(Model.PaidAmount?.ToString("C") ?? "0.0")</p>
        <p><strong>Saldo pendiente:</strong> @(Model.Total - Model.PaidAmount).ToString("C")</p>
        <p><strong>Estado actual:</strong> @Model.Status</p>
    </div>
</div>

@if (User.IsInRole("Admin") || User.IsInRole("Contador"))
{
    if (!isReadOnly)
    {
        <form asp-action="AddPayment" method="post" class="mt-4">
            <input type="hidden" name="invoiceId" value="@Model.InvoiceId" />

            <div class="mb-3">
                <label class="form-label">Monto del Pago</label>
                <input type="number" step="0.01" name="amount" class="form-control" required min="0.01" />
            </div>

            <div class="mb-3">
                <label class="form-label">Notas</label>
                <textarea name="notes" class="form-control" rows="3" placeholder="Detalles del pago..."></textarea>
            </div>

            <button type="submit" class="btn btn-success">Registrar Pago</button>
            <a asp-action="Details" asp-route-id="@Model.InvoiceId" class="btn btn-secondary ms-2">Volver</a>
        </form>
    }
    else
    {
        <div class="alert alert-warning mt-4">
            No se puede registrar pagos porque la factura está <strong>@Model.Status</strong>.
        </div>
        <a asp-action="Details" asp-route-id="@Model.InvoiceId" class="btn btn-secondary">Volver</a>
    }
}
else
{
    <div class="alert alert-danger mt-4">
        No tienes permisos para registrar pagos.
    </div>
    <a asp-action="Details" asp-route-id="@Model.InvoiceId" class="btn btn-secondary">Volver</a>
}