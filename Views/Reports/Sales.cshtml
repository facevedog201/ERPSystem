@model IEnumerable<ERPSystem.Models.Invoice>
@using System.Globalization

@{
    ViewData["Title"] = "Ventas";
    var list = Model.ToList();
    var culture = new CultureInfo("es-NI");

    decimal totalFacturado = list.Sum(i => i.Total ?? 0);
    decimal totalPagado = list.Sum(i => i.PaidAmount ?? 0);
    decimal totalPendiente = list.Sum(i => (i.Total ?? 0) - (i.PaidAmount ?? 0));
}
@section Styles {
    <link rel="stylesheet" href="~/css/print.css" />
}
<!-- Encabezado visible solo en impresión -->
<div class="print-header">
    <img src="~/images/logo.png" alt="Logo" style="height:40px;" />
    <div>ERPSystem - Reporte de Ventas</div>
</div>

<h2 class="no-print">Ventas</h2>

<form method="get" class="row g-2 mb-3 no-print">
    <div class="col-md-3">
        <input type="date" name="from" class="form-control"
               value="@((ViewBag.From as DateTime?)?.ToString("yyyy-MM-dd"))" />
    </div>
    <div class="col-md-3">
        <input type="date" name="to" class="form-control"
               value="@((ViewBag.To as DateTime?)?.ToString("yyyy-MM-dd"))" />
    </div>
    <div class="col-md-3">
        <select name="clientId" class="form-select">
            <option value="0">-- Todos --</option>
            @foreach (var c in ViewBag.Clients as List<ERPSystem.Models.Client>)
            {
                <option value="@c.ClientId" selected="@(ViewBag.ClientId == c.ClientId ? "selected" : null)">
                    @c.Name
                </option>
            }
        </select>
    </div>
    <div class="col-md-3">
        <button class="btn btn-primary">
            <i class="bi bi-funnel-fill"></i> Filtrar
        </button>
        <a class="btn btn-outline-success ms-2"
           href="@Url.Action("Sales", new { from = (ViewBag.From as DateTime?)?.ToString("yyyy-MM-dd"), to = (ViewBag.To as DateTime?)?.ToString("yyyy-MM-dd"), clientId = ViewBag.ClientId, export = "excel" })">
            <i class="bi bi-file-earmark-excel-fill"></i> Exportar Excel
        </a>
    </div>
</form>

<table class="table table-striped table-bordered align-middle">
    <thead class="table-dark">
        <tr>
            <th>#</th>
            <th>Cliente</th>
            <th>Fecha</th>
            <th class="text-end">Total Facturado</th>
            <th class="text-end">Pagado</th>
            <th class="text-end">Saldo Pendiente</th>
            <th>Estado</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var inv in list)
        {
            // 🧠 Cálculo de saldo y estado legible
            var total = inv.Total ?? 0;
            var pagado = inv.PaidAmount ?? 0;
            var pendiente = total - pagado;

            // Fix: Compare with string values, not int
            string estado = inv.Status switch
            {
                1 => "Pendiente",
                2 => "Pagada",
                3 => "Anulada",
                _ => pendiente > 0 && pagado > 0 ? "Parcial" :
                pendiente <= 0 ? "Pagada" :
                "Pendiente"
            };

            <tr>
                <td>@inv.InvoiceId</td>
                <td>@inv.Client?.Name</td>
                <td>@inv.InvoiceDate?.ToString("dd/MM/yyyy")</td>
                <td class="text-end">@string.Format(culture, "{0:C}", total)</td>
                <td class="text-end">@string.Format(culture, "{0:C}", pagado)</td>
                <td class="text-end">@string.Format(culture, "{0:C}", pendiente)</td>
                <td>
                    @if (estado == "Pagada")
                    {
                        <span class="badge bg-success">@estado</span>
                    }
                    else if (estado == "Parcial")
                    {
                        <span class="badge bg-warning text-dark">@estado</span>
                    }
                    else if (estado == "Anulada")
                    {
                        <span class="badge bg-danger">@estado</span>
                    }
                    else
                    {
                        <span class="badge bg-secondary">@estado</span>
                    }
                </td>
            </tr>
        }

        <tr class="fw-bold table-total">
            <td colspan="3" class="text-end">Totales</td>
            <td class="text-end">@string.Format(culture, "{0:C}", totalFacturado)</td>
            <td class="text-end">@string.Format(culture, "{0:C}", totalPagado)</td>
            <td class="text-end">@string.Format(culture, "{0:C}", totalPendiente)</td>
            <td></td>
        </tr>
    </tbody>
</table>

<!-- Botones de acción (no se imprimen) -->
<div class="d-flex justify-content-between align-items-center mb-3 no-print">
    <div>
        <button class="btn btn-primary me-2" onclick="window.print()">
            <i class="bi bi-printer"></i> Imprimir
        </button>
        <a asp-action="Index" class="btn btn-danger">
            <i class="bi bi-arrow-left-circle"></i> Volver
        </a>
    </div>
</div>